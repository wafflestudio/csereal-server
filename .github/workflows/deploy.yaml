on:
    push:
        branches:
            - main
            - cicd/deploy # TODO: remove after testing

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            -
                name: Checkout
                uses: actions/checkout@v3

            - 
                name: Setup Java JDK
                uses: actions/setup-java@v3.12.0
                with:
                    java-version: '17'
                    distribution: 'adopt'

            -
                run: ./gradlew clean bootJar -x test

            - 
                name: Docker Setup Buildx
                uses: docker/setup-buildx-action@v2.9.1

            - 
                name: Build and push Docker images
                uses: docker/build-push-action@v4.1.1
                with:
                    push: true
                    tags: ghcr.io/wafflestudio/csereal-server/server_image:main
    
            -
                name: SCP Command to Transfer Files
                uses: appleboy/scp-action@v0.1.4
                with:
                    host: ${{secrets.SSH_HOST}}
                    username: ${{secrets.SSH_USER}}
                    key: ${{secrets.SSH_KEY}}
                    source: "docker-compose.yml"
                    target: "~/app"
                    overwrite: true
            -
                name: SSH Remote Commands
                uses: appleboy/ssh-action@v1.0.0
                with:
                    host: ${{secrets.SSH_HOST}}
                    username: ${{secrets.SSH_USER}}
                    key: ${{secrets.SSH_KEY}}
                    script: |
                        cd ~/app
                        export MYSQL_ROOT_PASSWORD=${{secrets.MYSQL_ROOT_PASSWORD}}
                        export MYSQL_USER=${{secrets.MYSQL_USER}}
                        export MYSQL_PASSWORD=${{secrets.MYSQL_PASSWORD}}
                        export MYSQL_DATABASE=${{secrets.MYSQL_DATABASE}}
                        export MYSQL_ROOT_PASSWORD=${{secrets.MYSQL_ROOT_PASSWORD}}
                        docker-compose down
                        docker-compose pull
                        docker-compose up -d